{% extends "layout.html" %}
{% block content %}
  <section class="news-toolbar mb-4">
    <div class="news-toolbar-primary">
      <div>
        <span class="news-kicker text-uppercase">News intelligence</span>
        <div class="d-flex flex-wrap align-items-baseline gap-3">
          <h1 class="h4 mb-0">News &amp; Insights</h1>
          <div class="news-toolbar-meta d-flex flex-wrap align-items-center gap-3">
            {% if news_refreshed %}
              <span class="news-refresh text-white-50">Last refreshed {{ news_refreshed }}</span>
            {% endif %}
            <span class="news-count text-white-50">{{ news_total }} stories</span>
          </div>
        </div>
      </div>
      {% if active_tag %}
        <div class="news-active-category">
          <span class="badge bg-secondary">Category: {{ active_tag }}</span>
          <a href="{{ build_news_url(tag=None) }}" class="news-clear-link">Clear category</a>
        </div>
      {% endif %}
    </div>
    <div class="news-toolbar-controls">
      <button
        class="btn btn-outline-secondary btn-sm"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#advancedFilters"
        aria-expanded="{{ 'true' if selected_industries or selected_tags or active_preset else 'false' }}"
        data-filter-toggle="advancedFilters"
        data-expanded-text="Hide filters"
        data-collapsed-text="Advanced filters"
      >
        Advanced filters
      </button>
      <form class="news-search" action="{{ url_for('web.news_list') }}" method="get">
        {% if active_tag %}<input type="hidden" name="tag" value="{{ active_tag }}">{% endif %}
        {% if active_preset %}<input type="hidden" name="preset" value="{{ active_preset.id }}">{% endif %}
        {% for ind in selected_industries %}<input type="hidden" name="industries" value="{{ ind }}">{% endfor %}
        {% for t in selected_tags %}<input type="hidden" name="tags" value="{{ t }}">{% endfor %}
        <input type="hidden" name="tag_mode" value="{{ tag_mode }}">
        <input class="form-control news-search-input" type="search" name="q" placeholder="Search title or #tag" value="{{ q | default('') }}">
        <button class="btn btn-primary btn-sm" type="submit">Search</button>
      </form>
    </div>
    {% if theme_cards or quick_tags %}
      <div class="news-inline-filters">
        {% if theme_cards %}
          <div class="news-filter-group">
            <span class="news-filter-label text-white-50">Themes:</span>
            <div class="theme-chip-list">
              {% for theme in theme_cards %}
                <a href="{{ theme.href }}" class="theme-chip {% if theme.active %}active{% endif %}">
                  <span class="theme-chip-name">{{ theme.name }}</span>
                  {% if theme.description %}
                    <span class="theme-chip-desc">{{ theme.description }}</span>
                  {% endif %}
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}
    {% if selected_industries or selected_tags or q or active_preset %}
      <div class="news-active-filters">
        {% if active_preset %}
          <span class="news-active-chip">Preset: {{ active_preset.label }}</span>
        {% endif %}
        {% for s in selected_industries %}
          <span class="news-active-chip">Industry: {{ s }}</span>
        {% endfor %}
        {% for t in selected_tags %}
          <span class="news-active-chip">#{{ t.lstrip('#') }}</span>
        {% endfor %}
        {% if selected_tags %}
          <span class="news-active-chip">Tag mode: {{ tag_mode }}</span>
        {% endif %}
        {% if q %}
          <span class="news-active-chip">Search: {{ q }}</span>
        {% endif %}
        <a class="news-clear-link" href="{{ build_news_url(tag=active_tag, industries=None, tags=None, tag_mode=None, q=None, preset=None) }}">Clear filters</a>
      </div>
    {% endif %}
  </section>

  <div class="collapse advanced-filters-wrap mb-3 {% if selected_industries or selected_tags or active_preset %}show{% endif %}" id="advancedFilters">
    <div class="card card-dark shadow-sm advanced-filter-card">
      <div class="card-header d-flex align-items-center justify-content-between gap-3">
        <div>
          <span class="advanced-filter-kicker text-uppercase">Advanced filters</span>
          <p class="advanced-filter-subtitle mb-0 text-white-50">Choose a preset lens to reshape the feed</p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="{{ build_news_url(tag=active_tag, industries=None, tags=None, tag_mode=None, preset=None) }}">Reset</a>
          <button
            class="btn btn-outline-secondary btn-sm advanced-filter-toggle"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#advancedFilters"
            aria-expanded="true"
            data-filter-toggle="advancedFilters"
            data-expanded-text="Hide filters"
            data-collapsed-text="Show filters"
          >
            Hide filters
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="filter-chip-grid presets-grid">
          {% for preset in filter_presets %}
            <a class="filter-chip filter-chip-link {% if preset.active %}active{% endif %}" href="{{ preset.href }}">
              <span class="filter-chip-label">{{ preset.label }}</span>
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

{% if hot_tags %}
  <div class="card card-dark shadow-sm hotlist-card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <h2 class="h6 text-uppercase text-muted mb-1">Hot themes</h2>
          <p class="text-white-50 small mb-0">Momentum versus the broader news baseline</p>
        </div>
      </div>
      <div class="hotlist-grid">
        {% for item in hot_tags %}
          <a href="{{ item.href }}" class="hotlist-item trend-{{ item.trend }}">
            <div class="hotlist-topline">
              <span class="hotlist-label">#{{ item.label }}</span>
              <span class="badge text-bg-{{ item.sentiment_variant }}">
                <span class="me-1">{{ item.sentiment_icon }}</span>{{ item.sentiment_label }}
              </span>
            </div>
            <div class="hotlist-metrics">
              <span class="hotlist-share text-white-50 small">{{ item.share_display }} of view</span>
              <span class="hotlist-delta">{{ item.delta_display }}</span>
            </div>
            <div class="hotlist-sentiment text-white-50 small">Avg sentiment {{ item.sentiment_score }}</div>
          </a>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

{% if narratives %}
  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
      <h2 class="h6 text-uppercase text-muted mb-0">Narrative spotlight</h2>
      <span class="text-white-50 small">Clustered headlines with generated takeaways</span>
    </div>
    <div class="row g-3">
      {% for narrative in narratives %}
        <div class="col-12 col-lg-4">
          <div class="card shadow-sm narrative-card h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <span class="badge text-bg-info-subtle text-info text-uppercase small">#{{ narrative.tag }}</span>
                <span class="badge text-bg-{{ narrative.momentum_variant }} text-uppercase small">{{ narrative.momentum_label }}</span>
              </div>
              <h3 class="h5 narrative-headline mb-2">{{ narrative.headline }}</h3>
              {% if narrative.lead.title %}
                <p class="narrative-lead mb-2">
                  <a href="{{ narrative.lead.url or narrative.href }}" class="narrative-lead-link" target="_blank" rel="noopener">
                    {{ narrative.lead.title }}
                  </a>
                </p>
              {% endif %}
              {% if narrative.lead.summary %}
                <p class="text-white-50 small mb-3">{{ narrative.lead.summary | truncate(160, True) }}</p>
              {% endif %}
              <div class="narrative-metrics d-flex flex-wrap gap-2 mb-3">
                <span class="narrative-chip">
                  <span class="chip-label">Sentiment</span>
                  <span class="chip-value">
                    <span class="chip-icon">{{ narrative.sentiment_icon }}</span>
                    {{ narrative.sentiment_label }} ({{ narrative.sentiment_score }})
                  </span>
                </span>
                <span class="narrative-chip">
                  <span class="chip-label">Share</span>
                  <span class="chip-value">{{ narrative.share_display }}</span>
                </span>
                <span class="narrative-chip trend-{{ narrative.trend }}">
                  <span class="chip-label">Δ vs. baseline</span>
                  <span class="chip-value">{{ narrative.delta_display }}</span>
                </span>
              </div>
              {% if narrative.related %}
                <ul class="narrative-related list-unstyled mb-3">
                  {% for rel in narrative.related %}
                    <li>
                      <a href="{{ rel.href }}" class="narrative-related-link" target="_blank" rel="noopener">{{ rel.title }}</a>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
              <div class="mt-auto pt-2 d-flex flex-wrap gap-2">
                <a class="btn btn-sm btn-outline-light" href="{{ narrative.href }}">Explore #{{ narrative.tag }}</a>
                {% if narrative.lead.url %}
                  <a class="btn btn-sm btn-primary" href="{{ narrative.lead.url }}" target="_blank" rel="noopener">Read lead story</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

  {% if selected_industries or selected_tags or q %}
    <p class="text-muted small">
      {% if selected_industries %}Industries:
        {% for s in selected_industries %}<span class="badge bg-secondary me-1">{{ s }}</span>{% endfor %}
      {% endif %}
      {% if selected_tags %}Tags:
        {% for t in selected_tags %}<span class="badge text-bg-light me-1">#{{ t.lstrip('#') }}</span>{% endfor %}
        <span class="ms-1">(match {{ tag_mode }})</span>
      {% endif %}
      {% if q %} &middot; Query: <strong>{{ q }}</strong>{% endif %}
    </p>
  {% endif %}

  {% if q %}
    <p class="text-muted">Showing results for <strong>{{ q }}</strong>{% if active_tag %} in <strong>{{ active_tag }}</strong>{% endif %}.</p>
  {% endif %}

  {% if news_total == 0 %}
    <div class="alert alert-light border">No results. Try adjusting your search or filters.</div>
  {% endif %}

  <div class="row g-3">
    {% for n in news_items %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm news-card">
          <div class="card-body d-flex flex-column">
            <header class="news-card-header">
              <div class="news-source">
                <span class="news-source-avatar news-source-{{ n.credibility.variant }}">{{ n.source_initials }}</span>
                <div class="news-source-text">
                  <span class="news-source-name">{{ n.source_display }}</span>
                  <span class="news-source-meta">{{ n.date }}{% if n.category %} · {{ n.category }}{% endif %}</span>
                </div>
              </div>
              <span class="badge news-credibility text-bg-{{ n.credibility.variant }}" title="{{ n.credibility.description }}">{{ n.credibility.label }}</span>
            </header>
            <h3 class="news-card-title">{{ n.title }}</h3>
            <p class="news-card-summary">{{ n.summary }}</p>
            <div class="news-card-metrics">
              <span class="news-meta-chip">
                <svg class="news-meta-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 7a1 1 0 0 1 1 1v3.17l2.12 2.12a1 1 0 0 1-1.41 1.41l-2.47-2.47A1 1 0 0 1 11 12V8a1 1 0 0 1 1-1Zm0-5a10 10 0 1 1-10 10A10 10 0 0 1 12 2Zm0 2a8 8 0 1 0 8 8a8 8 0 0 0-8-8Z"/></svg>
                ~{{ n.read_minutes }} min read
              </span>
              <span class="news-meta-chip sentiment sentiment-{{ n.sentiment.variant }}">
                <span class="sentiment-icon">{{ n.sentiment.icon }}</span>
                {{ n.sentiment.label }}
              </span>
            </div>
            {% if n.context %}
              <div class="news-context mt-3">
                <div class="news-context-title">{{ n.context.title }}</div>
                <p class="text-white-50 small mb-2">{{ n.context.insight }}</p>
                {% if n.context.ticker %}
                  <div class="news-context-pill">Ticker: {{ n.context.ticker }}</div>
                {% endif %}
                {% if n.context.actions %}
                  <div class="news-context-actions d-flex flex-wrap gap-2 mt-2">
                    {% for action in n.context.actions %}
                      <a href="{{ action.href }}" class="btn btn-sm btn-outline-primary">{{ action.label }}</a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endif %}
            <div class="news-card-footer mt-auto pt-3">
              <div class="news-tag-list">
                {% for t in n.tags %}
                  <a href="{{ build_news_url(q='#' ~ t) }}" class="badge news-chip text-decoration-none">#{{ t }}</a>
                {% endfor %}
              </div>
              {% if n.url %}
                <a href="{{ n.url }}" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener">Read full story</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const collapseEl = document.getElementById("advancedFilters");
      if (!collapseEl) {
        return;
      }
      const toggles = document.querySelectorAll('[data-filter-toggle="advancedFilters"]');
      if (!toggles.length) {
        return;
      }

      const updateLabels = () => {
        const isOpen = collapseEl.classList.contains("show");
        toggles.forEach((btn) => {
          const expanded = btn.dataset.expandedText || btn.textContent.trim();
          const collapsed = btn.dataset.collapsedText || btn.textContent.trim();
          btn.textContent = isOpen ? expanded : collapsed;
          btn.setAttribute("aria-expanded", String(isOpen));
        });
      };

      collapseEl.addEventListener("shown.bs.collapse", updateLabels);
      collapseEl.addEventListener("hidden.bs.collapse", updateLabels);

      updateLabels();
    });
  </script>
{% endblock %}
