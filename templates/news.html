{% extends "layout.html" %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <h1 class="h4 mb-0">News &amp; Insights</h1>
      {% if active_tag %}
        <div class="mt-1">
          <span class="badge bg-secondary">Category: {{ active_tag }}</span>
          <a href="{{ build_news_url(tag=None) }}" class="btn btn-sm btn-link">Clear category</a>
        </div>
      {% endif %}
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="{{ 'true' if selected_industries or selected_tags else 'false' }}">Advanced Filters</button>
      <form class="d-flex" action="{{ url_for('web.news_list') }}" method="get">
        {% if active_tag %}<input type="hidden" name="tag" value="{{ active_tag }}">{% endif %}
        {% for ind in selected_industries %}<input type="hidden" name="industries" value="{{ ind }}">{% endfor %}
        {% for t in selected_tags %}<input type="hidden" name="tags" value="{{ t }}">{% endfor %}
        <input type="hidden" name="tag_mode" value="{{ tag_mode }}">
        <input class="form-control me-2" type="search" name="q" placeholder="Search title, summary, #tag" value="{{ q | default('') }}">
        <button class="btn btn-primary" type="submit">Search</button>
      </form>
    </div>
  </div>

  <div class="collapse mb-3 {% if selected_industries or selected_tags %}show{% endif %}" id="advancedFilters">
    <form class="card card-dark shadow-sm p-3" action="{{ url_for('web.news_list') }}" method="get">
      {% if active_tag %}<input type="hidden" name="tag" value="{{ active_tag }}">{% endif %}
      <input type="hidden" name="q" value="{{ q }}">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label fw-semibold">Industries</label>
          <div class="d-flex flex-wrap gap-3">
            {% for cat in categories %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="industries" value="{{ cat }}" id="ind-{{ loop.index }}" {% if cat in selected_industries %}checked{% endif %}>
                <label class="form-check-label" for="ind-{{ loop.index }}">{{ cat }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <div class="d-flex align-items-center justify-content-between">
            <label class="form-label fw-semibold mb-0"># Tags</label>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0 small">Match</label>
              <select class="form-select form-select-sm" name="tag_mode" style="width:auto">
                <option value="any" {% if tag_mode != 'all' %}selected{% endif %}>any</option>
                <option value="all" {% if tag_mode == 'all' %}selected{% endif %}>all</option>
              </select>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            {% for tag, count in top_tags %}
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="tags" value="{{ tag }}" id="tag-{{ loop.index }}" {% if tag in selected_tags or ('#' ~ tag) in selected_tags %}checked{% endif %}>
                <label class="form-check-label" for="tag-{{ loop.index }}">#{{ tag }} <span class="text-muted">({{ count }})</span></label>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Apply filters</button>
          <a class="btn btn-outline-secondary" href="{{ build_news_url(tag=active_tag, industries=None, tags=None, tag_mode=None) }}">Clear filters</a>
        </div>
      </div>
    </form>
  </div>

  <div class="mb-3">
    <div class="row g-2">
      <div class="col-6 col-sm-4 col-md-3 col-lg-2">
        <a href="{{ build_news_url(tag=None) }}" class="text-decoration-none">
          <div class="card h-100 shadow-sm category-card {% if not active_tag %}border-primary{% endif %}">
            <div class="card-body py-3 d-flex align-items-center justify-content-center">
              <span class="fw-semibold {% if not active_tag %}text-primary{% endif %}">All</span>
            </div>
          </div>
        </a>
      </div>
      {% for cat in categories if cat != 'System' %}
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
          <a href="{{ build_news_url(tag=cat) }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm category-card {% if active_tag == cat %}border-primary{% endif %}">
              <div class="card-body py-3 d-flex flex-column align-items-center justify-content-center text-center">
                <span class="fw-semibold {% if active_tag == cat %}text-primary{% endif %}">{{ cat }}</span>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>

  {% if selected_industries or selected_tags or q %}
    <p class="text-muted small">
      {% if selected_industries %}Industries:
        {% for s in selected_industries %}<span class="badge bg-secondary me-1">{{ s }}</span>{% endfor %}
      {% endif %}
      {% if selected_tags %}Tags:
        {% for t in selected_tags %}<span class="badge text-bg-light me-1">#{{ t.lstrip('#') }}</span>{% endfor %}
        <span class="ms-1">(match {{ tag_mode }})</span>
      {% endif %}
      {% if q %} &middot; Query: <strong>{{ q }}</strong>{% endif %}
    </p>
  {% endif %}

  {% if q %}
    <p class="text-muted">Showing results for <strong>{{ q }}</strong>{% if active_tag %} in <strong>{{ active_tag }}</strong>{% endif %}.</p>
  {% endif %}

  {% if items|length == 0 %}
    <div class="alert alert-light border">No results. Try adjusting your search or filters.</div>
  {% endif %}

  <div class="row g-3">
    {% for n in items if n.category != 'System' and not n.id.startswith('system:') %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex flex-column">
            <h3 class="h5 card-title">{{ n.title }}</h3>
            <p class="text-muted small mb-2">{{ n.source }} • {{ n.date }}{% if n.category %} • {{ n.category }}{% endif %}</p>
            <p class="card-text">{{ n.summary }}</p>
            <div class="mt-auto pt-2">
              {% for t in n.tags %}
                <a href="{{ build_news_url(q='#' ~ t) }}" class="badge text-bg-light me-1 mb-1 text-decoration-none">#{{ t }}</a>
              {% endfor %}
              {% if n.url %}
                <div class="mt-2">
                  <a href="{{ n.url }}" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener">Read more</a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
