{% extends "layout.html" %}
{% block content %}
  <section class="news-toolbar mb-4">
    <div class="news-toolbar-primary">
      <div>
        <span class="news-kicker text-uppercase">News intelligence</span>
        <div class="d-flex flex-wrap align-items-baseline gap-3">
          <h1 class="h4 mb-0">News &amp; Insights</h1>
          <div class="news-toolbar-meta d-flex flex-wrap align-items-center gap-3">
            {% if news_refreshed %}
              <span class="news-refresh text-white-50">Last refreshed {{ news_refreshed }}</span>
            {% endif %}
            <span class="news-count text-white-50">{{ news_total }} stories</span>
          </div>
        </div>
      </div>
      {% if active_tag %}
        <div class="news-active-category">
          <span class="badge bg-secondary">Category: {{ active_tag }}</span>
          <a href="{{ build_news_url(tag=None) }}" class="news-clear-link">Clear category</a>
        </div>
      {% endif %}
    </div>
    <div class="news-toolbar-controls">
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="{{ 'true' if selected_industries or selected_tags else 'false' }}">Advanced filters</button>
      <form class="news-search" action="{{ url_for('web.news_list') }}" method="get">
        {% if active_tag %}<input type="hidden" name="tag" value="{{ active_tag }}">{% endif %}
        {% for ind in selected_industries %}<input type="hidden" name="industries" value="{{ ind }}">{% endfor %}
        {% for t in selected_tags %}<input type="hidden" name="tags" value="{{ t }}">{% endfor %}
        <input type="hidden" name="tag_mode" value="{{ tag_mode }}">
        <input class="form-control news-search-input" type="search" name="q" placeholder="Search title, summary, or #tag" value="{{ q | default('') }}">
        <button class="btn btn-primary btn-sm" type="submit">Search</button>
      </form>
    </div>
    {% if filter_presets or quick_tags %}
      <div class="news-inline-filters">
        {% if filter_presets %}
          <div class="news-filter-group">
            <span class="news-filter-label text-white-50">Quick lenses:</span>
            <div class="news-filter-chip-list">
              {% for preset in filter_presets %}
                <a href="{{ preset.href }}" class="news-filter-chip {% if preset.active %}active{% endif %}">{{ preset.label }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        {% if quick_tags %}
          <div class="news-filter-group">
            <span class="news-filter-label text-white-50">Trending tags:</span>
            <div class="news-filter-chip-list">
              {% for tag in quick_tags %}
                <a href="{{ tag.href }}" class="news-tag-chip">#{{ tag.tag }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}
    {% if selected_industries or selected_tags or q %}
      <div class="news-active-filters">
        {% for s in selected_industries %}
          <span class="news-active-chip">Industry: {{ s }}</span>
        {% endfor %}
        {% for t in selected_tags %}
          <span class="news-active-chip">#{{ t.lstrip('#') }}</span>
        {% endfor %}
        {% if selected_tags %}
          <span class="news-active-chip">Tag mode: {{ tag_mode }}</span>
        {% endif %}
        {% if q %}
          <span class="news-active-chip">Search: {{ q }}</span>
        {% endif %}
        <a class="news-clear-link" href="{{ build_news_url(tag=active_tag, industries=None, tags=None, tag_mode=None, q=None) }}">Clear filters</a>
      </div>
    {% endif %}
  </section>

  <div class="collapse mb-3 {% if selected_industries or selected_tags %}show{% endif %}" id="advancedFilters">
    <form class="card card-dark shadow-sm p-3" action="{{ url_for('web.news_list') }}" method="get">
      {% if active_tag %}<input type="hidden" name="tag" value="{{ active_tag }}">{% endif %}
      <input type="hidden" name="q" value="{{ q }}">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label fw-semibold">Industries</label>
          <div class="d-flex flex-wrap gap-3">
            {% for cat in categories %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="industries" value="{{ cat }}" id="ind-{{ loop.index }}" {% if cat in selected_industries %}checked{% endif %}>
                <label class="form-check-label" for="ind-{{ loop.index }}">{{ cat }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <div class="d-flex align-items-center justify-content-between">
            <label class="form-label fw-semibold mb-0"># Tags</label>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0 small">Match</label>
              <select class="form-select form-select-sm" name="tag_mode" style="width:auto">
                <option value="any" {% if tag_mode != 'all' %}selected{% endif %}>any</option>
                <option value="all" {% if tag_mode == 'all' %}selected{% endif %}>all</option>
              </select>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            {% for tag, count in top_tags %}
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="tags" value="{{ tag }}" id="tag-{{ loop.index }}" {% if tag in selected_tags or ('#' ~ tag) in selected_tags %}checked{% endif %}>
                <label class="form-check-label" for="tag-{{ loop.index }}">#{{ tag }} <span class="text-muted">({{ count }})</span></label>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Apply filters</button>
          <a class="btn btn-outline-secondary" href="{{ build_news_url(tag=active_tag, industries=None, tags=None, tag_mode=None) }}">Clear filters</a>
        </div>
      </div>
    </form>
  </div>

  {% if on_radar %}
    <div class="card shadow-sm news-radar-card mb-4">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <h2 class="h6 text-uppercase text-muted mb-1">On the radar</h2>
            <p class="text-white-50 small mb-0">Sectors with the biggest news momentum right now</p>
          </div>
          <span class="text-white-50 small">Volume &amp; sentiment vs recent baseline</span>
        </div>
        <div class="news-radar-strip">
          {% for radar in on_radar %}
            <div class="news-radar-item news-radar-item-{{ radar.momentum_variant }} h-100 position-relative">
              <div class="news-radar-topline d-flex align-items-start justify-content-between mb-2">
                <div>
                  <h3 class="h6 mb-1">{{ radar.category }}</h3>
                  <span class="badge text-bg-{{ radar.tone_variant }} text-uppercase small">{{ radar.tone_label }}</span>
                </div>
                <div class="text-end">
                  <span class="badge bg-primary-subtle text-primary-emphasis">{{ radar.count }} stories</span>
                  <div class="text-white-50 small">{{ radar.share_display }} of list</div>
                </div>
              </div>
              <div class="news-radar-metrics d-flex flex-wrap gap-2 mb-2">
                <div class="news-radar-metric news-radar-metric-{{ radar.volume_trend }}">
                  <span class="metric-label">Volume Δ</span>
                  <span class="metric-value">{{ radar.volume_delta_display }}</span>
                </div>
                <div class="news-radar-metric news-radar-metric-{{ radar.sentiment_trend }}">
                  <span class="metric-label">Sentiment</span>
                  <span class="metric-value">{{ radar.sentiment_delta_display }}</span>
                </div>
                <div class="news-radar-metric news-radar-metric-neutral">
                  <span class="metric-label">Avg tone</span>
                  <span class="metric-value">{{ radar.sentiment_avg_display }}</span>
                </div>
              </div>
              {% if radar.headline %}
                <p class="text-white-50 small mb-2">{{ radar.headline | truncate(112, True) }}</p>
              {% endif %}
              {% if radar.top_tag_links %}
                <div class="d-flex flex-wrap gap-1 mb-2">
                  {% for tag in radar.top_tag_links %}
                    <a href="{{ tag.href }}" class="badge news-chip text-decoration-none">#{{ tag.tag }}</a>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="text-white-50 small">Baseline share: {{ radar.baseline_share_display }}</div>
              <a href="{{ radar.href }}" class="stretched-link"></a>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  {% if story_clusters %}
    <div class="mb-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
        <h2 class="h6 text-uppercase text-muted mb-0">Story clusters</h2>
        <span class="text-white-50 small">Top narratives in this view</span>
      </div>
      <div class="row g-3">
        {% for cluster in story_clusters %}
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm story-cluster-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="badge bg-info-subtle text-info text-uppercase small">#{{ cluster.tag }}</span>
                  <span class="text-white-50 small">{{ cluster.count }} mentions</span>
                </div>
                <h3 class="h5 mb-2">{{ cluster.primary.title }}</h3>
                <p class="text-white-75 small mb-3">{{ cluster.primary.summary | default('') | truncate(160, True) }}</p>
                {% if cluster.bullets %}
                  <ul class="story-cluster-list mb-3">
                    {% for bullet in cluster.bullets %}
                      <li>
                        <a href="{{ bullet.href }}" class="story-cluster-link" target="_blank" rel="noopener">{{ bullet.title }}</a>
                        {% if bullet.summary %}
                          <p class="text-white-50 small mb-0">{{ bullet.summary | truncate(110, True) }}</p>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
                <div class="d-flex flex-wrap gap-2">
                  <a class="btn btn-sm btn-outline-light" href="{{ cluster.href }}">Explore #{{ cluster.tag }}</a>
                  {% if cluster.primary.url %}
                    <a class="btn btn-sm btn-primary" href="{{ cluster.primary.url }}" target="_blank" rel="noopener">Read lead story</a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="mb-3">
    <div class="row g-2">
      <div class="col-6 col-sm-4 col-md-3 col-lg-2">
        <a href="{{ build_news_url(tag=None) }}" class="text-decoration-none">
          <div class="card h-100 shadow-sm category-card {% if not active_tag %}border-primary{% endif %}">
            <div class="card-body py-3 d-flex align-items-center justify-content-center">
              <span class="fw-semibold {% if not active_tag %}text-primary{% endif %}">All</span>
            </div>
          </div>
        </a>
      </div>
      {% for cat in categories if cat != 'System' %}
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
          <a href="{{ build_news_url(tag=cat) }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm category-card {% if active_tag == cat %}border-primary{% endif %}">
              <div class="card-body py-3 d-flex flex-column align-items-center justify-content-center text-center">
                <span class="fw-semibold {% if active_tag == cat %}text-primary{% endif %}">{{ cat }}</span>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>

  {% if selected_industries or selected_tags or q %}
    <p class="text-muted small">
      {% if selected_industries %}Industries:
        {% for s in selected_industries %}<span class="badge bg-secondary me-1">{{ s }}</span>{% endfor %}
      {% endif %}
      {% if selected_tags %}Tags:
        {% for t in selected_tags %}<span class="badge text-bg-light me-1">#{{ t.lstrip('#') }}</span>{% endfor %}
        <span class="ms-1">(match {{ tag_mode }})</span>
      {% endif %}
      {% if q %} &middot; Query: <strong>{{ q }}</strong>{% endif %}
    </p>
  {% endif %}

  {% if q %}
    <p class="text-muted">Showing results for <strong>{{ q }}</strong>{% if active_tag %} in <strong>{{ active_tag }}</strong>{% endif %}.</p>
  {% endif %}

  {% if news_total == 0 %}
    <div class="alert alert-light border">No results. Try adjusting your search or filters.</div>
  {% endif %}

  <div class="row g-3">
    {% for n in news_items %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm news-card">
          <div class="card-body d-flex flex-column">
            <header class="news-card-header">
              <div class="news-source">
                <span class="news-source-avatar news-source-{{ n.credibility.variant }}">{{ n.source_initials }}</span>
                <div class="news-source-text">
                  <span class="news-source-name">{{ n.source_display }}</span>
                  <span class="news-source-meta">{{ n.date }}{% if n.category %} · {{ n.category }}{% endif %}</span>
                </div>
              </div>
              <span class="badge news-credibility text-bg-{{ n.credibility.variant }}" title="{{ n.credibility.description }}">{{ n.credibility.label }}</span>
            </header>
            <h3 class="news-card-title">{{ n.title }}</h3>
            <p class="news-card-summary">{{ n.summary }}</p>
            <div class="news-card-metrics">
              <span class="news-meta-chip">
                <svg class="news-meta-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 7a1 1 0 0 1 1 1v3.17l2.12 2.12a1 1 0 0 1-1.41 1.41l-2.47-2.47A1 1 0 0 1 11 12V8a1 1 0 0 1 1-1Zm0-5a10 10 0 1 1-10 10A10 10 0 0 1 12 2Zm0 2a8 8 0 1 0 8 8a8 8 0 0 0-8-8Z"/></svg>
                ~{{ n.read_minutes }} min read
              </span>
              <span class="news-meta-chip sentiment sentiment-{{ n.sentiment.variant }}">
                <span class="sentiment-icon">{{ n.sentiment.icon }}</span>
                {{ n.sentiment.label }}
              </span>
            </div>
            {% if n.context %}
              <div class="news-context mt-3">
                <div class="news-context-title">{{ n.context.title }}</div>
                <p class="text-white-50 small mb-2">{{ n.context.insight }}</p>
                {% if n.context.ticker %}
                  <div class="news-context-pill">Ticker: {{ n.context.ticker }}</div>
                {% endif %}
                {% if n.context.actions %}
                  <div class="news-context-actions d-flex flex-wrap gap-2 mt-2">
                    {% for action in n.context.actions %}
                      <a href="{{ action.href }}" class="btn btn-sm btn-outline-primary">{{ action.label }}</a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endif %}
            <div class="news-card-footer mt-auto pt-3">
              <div class="news-tag-list">
                {% for t in n.tags %}
                  <a href="{{ build_news_url(q='#' ~ t) }}" class="badge news-chip text-decoration-none">#{{ t }}</a>
                {% endfor %}
              </div>
              {% if n.url %}
                <a href="{{ n.url }}" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener">Read full story</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
